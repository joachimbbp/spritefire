<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emoji Mirror</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">

  <script type="module">
    import init, { set_db, process_img, process_img_data } from "./pkg/spritefire_web.js"
    await init()
    set_db()

    const videoStreamProcessor = {
      doLoad() {
        this.video = document.getElementById("my-video");
        this.c1 = document.getElementById("my-canvas");
        this.scale = document.getElementById("downscale-slider");
        this.rate = document.getElementById("framerate-slider");
        this.ctx1 = this.c1.getContext("2d");
        this.ctx1.willReadFrequently = true;

        this.video.addEventListener(
          "play",
          () => {
            this.width = this.video.width;
            this.height = this.video.height;
            this.timerCallback();
          },
          false,
        );
      },

      timerCallback() {
        if (this.video.paused || this.video.ended) {
          return;
        }
        this.computeFrame();
        requestAnimationFrame(() => {
          this.timerCallback();
        }, 1000 / this.rate.value);
      },

      computeFrame() {
        this.ctx1.drawImage(this.video, 0, 0, this.width, this.height);
        const frame = this.ctx1.getImageData(0, 0, this.width, this.height);
        const resultString = process_img_data(frame, this.scale.value);
        document.getElementById("result").innerText = resultString;
      },
    };

    // Find media devices and set video stream from the selected or default device
    function setVideoElementFromDevice() {
      var videoElement = document.querySelector('video');
      var videoSelect = document.querySelector('select#videoSource');
      videoSelect.onchange = getStream;
      videoSelect.addEventListener("click", getStream)
      getStream().then(getDevices).then(gotDevices);

      function getDevices() {
        // AFAICT in Safari this only gets default devices until gUM is called :/
        return navigator.mediaDevices.enumerateDevices();
      }

      function gotDevices(deviceInfos) {
        window.deviceInfos = deviceInfos; // make available to console
        console.log('Available input and output devices:', deviceInfos);
        for (const deviceInfo of deviceInfos) {
          const option = document.createElement('option');
          option.value = deviceInfo.deviceId;
          if (deviceInfo.kind === 'videoinput') {
            option.text = deviceInfo.label || `Camera ${videoSelect.length + 1}`;
            videoSelect.appendChild(option);
          }
        }
      }

      function getStream() {
        if (window.stream) {
          window.stream.getTracks().forEach(track => {
            track.stop();
          });
        }
        const videoSource = videoSelect.value;
        const constraints = {
          audio: false,
          video: { deviceId: videoSource ? { exact: videoSource } : undefined, width: 1280, height: 720 }
        };
        return navigator.mediaDevices.getUserMedia(constraints).
          then(gotStream).catch();
      }

      function gotStream(stream) {
        window.stream = stream; // make stream available to console
        videoSelect.selectedIndex = [...videoSelect.options].
          findIndex(option => option.text === stream.getVideoTracks()[0].label);
        videoElement.srcObject = stream;
      }

      function handleError(error) {
        console.error('Error: ', error);
      }
    }

    function copyToClipboard() {
      const r = document.createRange();
      r.selectNode(document.getElementById("result"));
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(r);
      document.execCommand('copy');
      window.getSelection().removeAllRanges();
    }

    // Function to handle file selection and read the file
    function handleFileSelection(event) {
      const file = event.target.files[0];
      if (!file) {
        return; // No file selected
      }

      // stop video stream if it's playing
      document.querySelector('video').srcObject = null

      const reader = new FileReader();

      // set hook to execute after reading the file
      reader.addEventListener("load", (event) => {
        const bytes = new Uint8Array(event.target.result);
        const scale = document.getElementById("downscale-slider").value;
        const resultString = process_img(bytes, scale);
        document.getElementById("result").innerText = resultString;
      });

      reader.readAsArrayBuffer(file);
    }

    document.getElementById("filePicker").addEventListener("change", (event) => { handleFileSelection(event) })
    document.getElementById("copy-btn").addEventListener("click", copyToClipboard, false);
    setVideoElementFromDevice()
    videoStreamProcessor.doLoad()
  </script>
</head>

<body>
  <p>Gaze within the</p>
  <h2> Emoji Mirror </h2>

  <div class="select">
    <label for="videoSource">Video:</label><select id="videoSource"></select>
    <br>
    <label for="filePicker">Upload Image:</label>
    <input id="filePicker" type="file" accept=".png">
    <br>
    <label for="downscale-slider">Downscale:</label>
    <input type="range" id="downscale-slider" min="1" max="14" value="4">
    <br>
    <label for="downscale-slider">Framerate:</label>
    <input type="range" id="framerate-slider" min="4" max="24" value="12">
    <br>
    <button id="copy-btn">Copy to Clipboard!</button>
  </div>

  <div class="container">

    <div id="result"></div>
    <canvas id="my-canvas" width="640" height="360" hidden="true"></canvas>
    <video id="my-video" autoplay muted playsinline width="640" height="360">
    </video>
  </div>

  <style>
    :root {
      --size: calc(100vw / 420);
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: #000;
      color: #fff;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      text-align: center;
    }

    .container {
      position: relative;
    }

    #my-video {
      position: fixed;
      right: 0;
      top: 0;
      width: 180px;
      aspect-ratio: 16/9;
    }

    #result {
      border: #464242;
      border-style: solid;
      border-width: 15px;
      padding: 4px;
      max-width: fit-content;
      margin-left: auto;
      margin-right: auto;
      font-family: "Noto Color Emoji", sans-serif;
      font-size: var(--size);
      line-height: 1.2;
      background: #000;
      white-space: pre-wrap;
      text-align: left;
      margin: 0 auto;
    }
  </style>
</body>

</html>